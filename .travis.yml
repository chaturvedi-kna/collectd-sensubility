---

dist: xenial
language: go
go:
  - 1.13.3
env:
  global:
    - RABBITMQ_VERSION=3.7.24
    - QDROUTERD_VERSION=1.7.0
    - secure: "M7B+sKIyMGZ4Suf/Hnc+jRhwxq/Ch12eUVsdby2ipkZU80CaIz5jd/+pJT1SDQmPeoapJVTjuR8LhRkDyHtSysdY4n3kV6sW4OFJU82vyuEMHVMYg6TkXzGqUCZqpcO9oUREhlU0wH6IVZi0I01ervthgYyocS2Q4RQPVnk/NcTiZ2LTqKJ0Y38/BKpspYuTV2EPwfolrjTcfVypNl51TdKLawYP5MKLJmNMwEYnioGTQ8i0313jbnk0g80rq2UmBQXZcuiK2uXE9ap/7xuyR1IJB7iMIcAs5DN6YxzdLhJR5Qvv7YLSBNa+XhYMGfgHISp2Pnd8lSryCmiCFLirZxujD5WbsyMvpq8VaXLg+m5bdmWTONb7Jd+obOnD9Fa4/JUUqGmkPErwYMdWZOhykyO96pJnPrJ8yqmeRtjuMA3qHyoqZj2zJSzsuG75Jt0W3A72YVLiyQgRSdBRuQHyDpeySTYz7D3VWu68CkrXjPhWJGicNQbNqMXvE9fMgqwHes7u2GUWuusf3pEWf7WVqX/kBfI5Hjzk/HhSfSyYdgpI3bA1k6nrdAMYH/H9Yg0B96vQI0qwmxhiUKgGhLLk2FmsEgSKqV5Oa3/EZ9gsHRcn2Z6uRqvkw1A7/bYlz+y3Ln2wtKb/sIU+SxbP8cnCfTOOtjgNwWMbdbtt7a7Un1g="
services:
  - docker

before_install:
  - docker pull centos:7
  # start containerized QDR
  #- docker pull quay.io/interconnectedcloud/qdrouterd:$QDROUTERD_VERSION
  #- docker run --name=qdr -p 5666:5666 -d quay.io/interconnectedcloud/qdrouterd:$QDROUTERD_VERSION
  # start containerized RabbitMQ
  - docker pull rabbitmq:$RABBITMQ_VERSION
  - docker run --name=rabbitmq -p 5672:5672 -p 4369:4369 -d rabbitmq:$RABBITMQ_VERSION
  - sleep 10
  - docker exec rabbitmq rabbitmqctl start_app
  - sleep 5
  - docker exec rabbitmq rabbitmqctl add_vhost /sensu
  - docker exec rabbitmq rabbitmqctl set_permissions -p "/sensu" guest ".*" ".*" ".*"

install:
  - go get -u golang.org/x/lint/golint
  - go get -u github.com/golang/dep/...
  - dep ensure -v

# run unit test suit before smoke test
before_script:
  - go test -v ./...

# report test coverage after successful test run
after_script:
  - bash ci/report_coverage.sh

# run CI and report test coverage after successful test run
script:
  - export PROJECT_ROOT=/root/go/src/github.com/paramite/collectd-sensubility
  - docker run -uroot --network host -it --volume $PWD:$PROJECT_ROOT:z --workdir $PROJECT_ROOT centos:7 bash ci/run_ci.sh
